{% extends 'layouts/base.html' %} {% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}
<style>
  .hidden {
    display: none;
  }
</style>
<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
          <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
            <li class="breadcrumb-item">
              <a href="#"><i class="fas fa-home"></i></a>
            </li>
            <li class="breadcrumb-item"><a href="#">Dashboards</a></li>
          </ol>
        </nav>
      </div>
      <!-- Card stats -->
      <div class="row">
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->

            <div class="card-body" id="card_body_laser">
              <a href="{% url 'laser_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Laser Toptica</h5>
                    <span class="h2 font-weight-bold mb-0" id="laser_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                      <i class="ni ni-active-40"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_rfsoc">
              <a href="{% url 'rfsoc_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">RFSoC</h5>
                    <span class="h2 font-weight-bold mb-0" id="rfsoc_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                      <i class="ni ni-chart-pie-35"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_caylar">
              <a href="{% url 'caylar_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Caylar Magnetic</h5>
                    <span class="h2 font-weight-bold mb-0" id="caylar_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                      <i class="ni ni-money-coins"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_mercury">
              <a href="{% url 'mercury_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">MercuryITC (Cryostat)</h5>
                    <span class="h2 font-weight-bold mb-0" id="mercury_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                      <i class="ni ni-chart-bar-32"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-secondary my-4" id="update_button">Update Status</button>
    </div>
    <div id="messageUpdateExpContainer"></div>
  </div>
</div>
<div id="livePlot" class="hidden">
  <button type="button" class="btn btn-danger" id="pauseExperimentButton">Pause Experiment</button>
  <button type="button" class="btn btn-danger" id="continueExperimentButton">Continue Experiment</button>
  <button type="button" class="btn btn-danger" id="stopExperimentButton">Stop Experiment</button>
  <div class="col-auto">
    <!-- Placeholder for laser parameters -->
    <div class="parameter-number">Scan End: <span id="laser_scan_end_number">-</span></div>
    <div class="parameter-number">Scan Start: <span id="laser_scan_start_number">-</span></div>
    <div class="parameter-number">Scan Offset: <span id="laser_scan_offset_number">-</span></div>
    <div class="parameter-number">Scan Frequency: <span id="laser_scan_frequency_number">-</span></div>
    <div class="parameter-number">Scan Wavelength: <span id="laser_scan_wavelength_number">-</span></div>
  </div>
</div>
<div id="livePlotCaylar" class="hidden">
  <div class="col-auto">
    <div class="parameter-number">Caylar Current: <span id="caylar_current_number">-</span></div>
    <div class="parameter-number">Caylar Field: <span id="caylar_field_number">-</span></div>
    <div class="parameter-number">Caylar ADC/DAC Temp: <span id="caylar_adcdac_temp_number">-</span></div>
    <div class="parameter-number">Caylar Box Temp: <span id="caylar_box_temp_number">-</span></div>
    <div class="parameter-number">Caylar Rack Temp: <span id="caylar_rack_temp_number">-</span></div>
    <div class="parameter-number">Caylar Water Temp: <span id="caylar_water_temp_number">-</span></div>
    <div class="parameter-number">Caylar Water Flow: <span id="caylar_water_flow_number">-</span></div>
  </div>
</div>
<div id="livePlotITC" class="hidden">
  <div class="col-auto">
    <!-- Placeholder for ITC parameters -->
    <div class="parameter-number">ITC Heater Power: <span id="itc_heater_power_number">-</span></div>
    <div class="parameter-number">ITC Temperature: <span id="itc_temperature_number">-</span></div>
  </div>
</div>
<!-- Page content -->
<!-- <form id="experimentForms" method="POST" action="{% url 'home' %}"> -->
<form id="experimentForms" class="hidden" method="POST">
  <!-- <form id="experimentForms" method="POST"> -->
  {% csrf_token %} {{ experiment_formset.management_form }}
  <!-- Include management form here -->

  <div class="container-fluid mt--6">
    <div class="row">
      <div class="col">
        <div class="card shadow">
          <div id="messageLoadingContainer"></div>
          <div id="messageContainer"></div>
          <div class="card-header bg-transparent">
            <h3 class="mb-0">Experiments</h3>
          </div>
          <input type="hidden" id="experimentCountInput" name="experimentCount" value="{{ experiment_forms|length }}" />
          <div class="form-group px-4 py-4">
            <label for="id_experiment_name">Experiment Name:</label>
            <input type="text" class="form-control" id="id_experiment_name" name="experiment_name" />
          </div>
          <div class="form-group px-4">
            <label for="id_experiment_description">Experiment Description:</label>
            <textarea class="form-control" id="id_experiment_description" name="description" rows="4"></textarea>
          </div>
          <div class="form-group px-4">
            <label for="id_file_Name">Experiment File:</label>
            <input type="text" class="form-control" id="id_file_Name" name="file_name" />
          </div>
          <div class="form-group">
            <label for="id_selected_devices">Select Devices:</label>
            <div class="col-auto">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="selected_devices[]" id="input-device-laser" value="Laser" />
                <label class="form-check-label" for="input-device-laser">Laser</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="selected_devices[]" id="input-device-mercuryitc" value="Mercury" />
                <label class="form-check-label" for="input-device-mercuryitc">MercuryITC</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="selected_devices[]" id="input-device-caylar" value="Caylar" />
                <label class="form-check-label" for="input-device-caylar">Caylar Magnet</label>
              </div>
            </div>
          </div>

          <div class="row px-4">
            <div class="card-body">
              <button type="submit" class="btn btn-primary" id="startExperimentButton">Start Experiment</button>
            </div>
          </div>
          <!-- <div id="messageLoadingContainer"></div> -->
        </div>
        <div id="formSectionContainer"></div>
        <!-- Container for dynamically added form sections -->
      </div>
    </div>
  </div>
</form>

{% include "includes/footer.html" %} {% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include Plotly library -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  function appendToList(listName, element) {
    if (!Array.isArray(window[listName])) {
      window[listName] = [];
    }

    window[listName].push(element);

    if (window[listName].length > 100) {
      window[listName].shift();
    }
  }

  function validateDeviceListForm() {
    var checkboxes = document.querySelectorAll('input[name="selected_devices[]"]');
    var checkedCount = 0;
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        checkedCount++;
      }
    }
    if (checkedCount === 0) {
      alert("Please select at least one device.");
      return false; // Prevent form submission
    }
    return true; // Proceed with form submission
  }
  $(document).ready(function () {
    // Attach a submit event handler to the form
    // Add a click event handler to the "Stop Experiment" button
    $("#stopExperimentButton").on("click", function () {
      stopExperiment();
    });
    $("#pauseExperimentButton").on("click", function () {
      pauseExperiment();
    });
    $("#continueExperimentButton").on("click", function () {
      continueExperiment();
    });
    $("#experimentForms").on("submit", function (event) {
      event.preventDefault(); // Prevent the default form submission

      // Serialize the form data
      let formData = $(this).serialize();
      $("#messageLoadingContainer").html('<div class="alert alert-info" role="alert">Loading...</div>');
      // Make an AJAX POST request only if the form is valid
      if (this.checkValidity() && validateDeviceListForm()) {
        $.ajax({
          url: "{% url 'start_experiment' %}",
          type: "POST",
          data: formData,
          success: function (response) {
            // Handle the response if needed
            $("#messageLoadingContainer .alert").remove();
            console.log(response);

            // Update the message dynamically from the response
            let messageContainer = $("#messageContainer");
            messageContainer.html('<div class="alert alert-success alert-dismissible fade show" role="alert">' + response.message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' + '<span aria-hidden="true">&times;</span>' + "</button>" + "</div>");

            // Reset the form fields
            $("#experimentForms")[0].reset();
            $("#experimentForms").addClass("hidden");
            isUpdating = true;
            updatePlot(1000);
          },
          error: function (xhr, status, error) {
            // Handle any error that occurs during the request
            console.log(error);

            // Update the message dynamically
            let messageContainer = $("#messageContainer");
            messageContainer.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' + xhr.responseJSON.message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' + '<span aria-hidden="true">&times;</span>' + "</button>" + "</div>");
          },
          complete: function () {
            // Remove the loading indicator
            $("#messageLoadingContainer .alert").remove();
          },
        });
      }
    });
  });
  function getCurrentDateTime() {
    let now = new Date();
    let year = now.getFullYear();
    let month = String(now.getMonth() + 1).padStart(2, "0");
    let day = String(now.getDate()).padStart(2, "0");
    let hours = String(now.getHours()).padStart(2, "0");
    let minutes = String(now.getMinutes()).padStart(2, "0");
    let seconds = String(now.getSeconds()).padStart(2, "0");
    let currentDateTime = year + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;
    return currentDateTime;
  }
  let xDate = [];
  // Initialize an empty data array
  let laser_scan_end = { x: xDate, y: [], mode: "lines+markers", name: "scan end" };
  let laser_scan_start = { x: xDate, y: [], mode: "lines+markers", name: "scan start" };
  let laser_scan_offset = { x: xDate, y: [], mode: "lines+markers", name: "scan offset" };
  let laser_scan_frequency = { x: xDate, y: [], mode: "lines+markers", name: "scan frequency" };
  let laser_scan_wavelength = { x: xDate, y: [], mode: "lines+markers", name: "scan wavelength" };
  // Caylar data
  let caylar_current = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Current" };
  let caylar_field = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Field" };
  let caylar_adcdac_temp = { x: xDate, y: [], mode: "lines+markers", name: "Caylar ADC/DAC Temperature" };
  let caylar_box_temp = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Box Temperature" };
  let caylar_rack_temp = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Rack Temperature" };
  let caylar_water_temp = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Water Temperature" };
  let caylar_water_flow = { x: xDate, y: [], mode: "lines+markers", name: "Caylar Water Flow" };
  let itc_heater_power = { x: xDate, y: [], mode: "lines+markers", name: "ITC Heater Power" };
  let itc_temperature = { x: xDate, y: [], mode: "lines+markers", name: "ITC Temperature" };
  let laser_data = [laser_scan_end, laser_scan_start, laser_scan_offset, laser_scan_frequency];
  let caylar_data = [caylar_current, caylar_field, caylar_adcdac_temp, caylar_box_temp, caylar_rack_temp, caylar_water_temp, caylar_water_flow];
  let itc_data = [itc_heater_power, itc_temperature];
  // Create an empty plot with a layout
  let layout = {
    title: "Live Plot Laser",
    xaxis: {
      title: "X-axis",
      type: "date",
    },
    yaxis: {
      title: "Y-axis",
    },
    autosize: false, // Disable automatic resizing
  };
  let layoutCaylar = {
    title: "Live Plot Caylar",
    xaxis: {
      title: "X-axis",
      type: "date",
    },
    yaxis: {
      title: "Y-axis",
    },
    autosize: false, // Disable automatic resizing
  };

  let layoutITC = {
    title: "Live Plot ITC",
    xaxis: {
      title: "X-axis",
      type: "date",
    },
    yaxis: {
      title: "Y-axis",
    },
    autosize: false, // Disable automatic resizing
  };

  // Create a plotly object with the laser_data and layout
  // let livePlot = Plotly.newPlot("livePlot", laser_data, layout);
  let isUpdating = false;
  // Function to update the plot with new data
  function updatePlot(interval) {
    if (!isUpdating) return;

    const currentDate = new Date();
    $("#livePlot").removeClass("hidden");
    $.ajax({
      url: "{% url 'live_data_rfsoc' %}", // Replace with your Django view URL
      type: "GET",
      dataType: "json",
      success: function (response) {
        // Update the data array with new data points
        xDate.push(getCurrentDateTime());
        // console.log(data);
        if (response.caylar_status == "ON") {
          $("#caylar_current_number").text(response.caylar_current);
          $("#caylar_field_number").text(response.caylar_field);
          $("#caylar_adcdac_temp_number").text(response.caylar_adcdac_temp);
          $("#caylar_box_temp_number").text(response.caylar_box_temp);
          $("#caylar_rack_temp_number").text(response.caylar_rack_temp);
          $("#caylar_water_temp_number").text(response.caylar_water_temp);
          $("#caylar_water_flow_number").text(response.caylar_water_flow);
          // Update Caylar data
          caylar_current["y"].push(response.caylar_current);
          caylar_field["y"].push(response.caylar_field);
          caylar_adcdac_temp["y"].push(response.caylar_adcdac_temp);
          caylar_box_temp["y"].push(response.caylar_box_temp);
          caylar_rack_temp["y"].push(response.caylar_rack_temp);
          caylar_water_temp["y"].push(response.caylar_water_temp);
          caylar_water_flow["y"].push(response.caylar_water_flow);
          // Update the Caylar plot with the new data
          let livePlotCaylar = Plotly.newPlot("livePlotCaylar", caylar_data, layoutCaylar);
        }
        if (response.mercury_status == "ON") {
          $("#itc_heater_power_number").text(response.itc_heater_power);
          $("#itc_temperature_number").text(response.itc_temperature);
          // Update ITC data
          itc_heater_power["y"].push(response.itc_heater_power);
          itc_temperature["y"].push(response.itc_temperature);
          // Update the ITC plot with the new data
          let livePlotITC = Plotly.newPlot("livePlotITC", itc_data, layoutITC);
        }
        if (response.laser_status == "ON") {
          $("#laser_scan_end_number").text(response.laser_scan_end);
          $("#laser_scan_start_number").text(response.laser_scan_start);
          $("#laser_scan_offset_number").text(response.laser_scan_offset);
          $("#laser_scan_frequency_number").text(response.laser_scan_frequency);
          $("#laser_scan_wavelength_number").text(response.laser_scan_wavelength);
          laser_scan_end["y"].push(response.laser_scan_end);
          laser_scan_start["y"].push(response.laser_scan_start);
          laser_scan_offset["y"].push(response.laser_scan_offset);
          laser_scan_frequency["y"].push(response.laser_scan_frequency);
          // Update the plot with the new data
          let livePlot = Plotly.newPlot("livePlot", laser_data, layout);
        }
      },
      error: function (xhr, status, error) {
        console.log(xhr.responseText);
      },
      complete: function () {
        // Call the updatePlot function again after the specified interval
        setTimeout(function () {
          updatePlot(interval);
        }, interval);
      },
    });
  }
  function stopExperiment() {
    isUpdating = false;
    $.ajax({
      url: "{% url 'stop_experiment' %}", // Replace with your Django view URL
      type: "GET",
      success: function (response) {
        // Handle the response if needed
        console.log(response);
        // Stop the plot updates
      },
      error: function (xhr, status, error) {
        // Handle any error that occurs during the request
        console.log(error);
      },
    });
  }
  function pauseExperiment() {
    isUpdating = true;
  }
  function continueExperiment() {
    isUpdating = true;
  }
  let statusCaylarElement = $("#caylar_status");
  let statusLaserElement = $("#laser_status");
  let statusRFSoCElement = $("#rfsoc_status");
  let statusMercuryElement = $("#mercury_status");

  function updateStatusColor(statusElement) {
    let statusText = statusElement.text().trim();
    statusElement.removeClass("text-success text-danger").css("color", "");

    if (statusText === "ON") {
      statusElement.addClass("text-success"); // Add green text color class
    } else if (statusText === "OFF") {
      statusElement.addClass("text-danger"); // Add red text color class
    } else {
      statusElement.css("color", "#adb5bd"); // Set text color to #adb5bd (gray)
    }
  }
  function updateStatus() {
    $("#messageUpdateExpContainer").html('<div class="alert alert-info" role="alert">Please Wait Until The Status Loading Finished</div>');
    $.ajax({
      url: "{% url 'status' %}", // URL mapped to the status view
      type: "GET",
      dataType: "json",
      success: function (data) {
        document.getElementById("rfsoc_status").innerHTML = data.rfsoc_status;
        document.getElementById("laser_status").innerHTML = data.laser_status;
        document.getElementById("mercury_status").innerHTML = data.mercury_status;
        document.getElementById("caylar_status").innerHTML = data.caylar_status;
        updateStatusColor(statusLaserElement);
        updateStatusColor(statusCaylarElement);
        updateStatusColor(statusMercuryElement);
        updateStatusColor(statusRFSoCElement);
      },
      error: function (xhr, errmsg, err) {
        console.log(xhr.status + ": " + xhr.responseText);
      },
      complete: function () {
        $("#experimentForms").removeClass("hidden");
        $("#messageUpdateExpContainer .alert").remove();
      },
    });
  }

  // Add event listener for the update button
  const updateButton = document.getElementById("update_button");
  updateButton.addEventListener("click", function () {
    updateStatusColor(statusLaserElement);
    updateStatusColor(statusCaylarElement);
    updateStatusColor(statusMercuryElement);
    updateStatusColor(statusRFSoCElement);
    updateStatus(); // Update the status immediately when the page loads
  });

  // Start the script once the HTML has finished loading
  document.addEventListener("DOMContentLoaded", function () {
    updateStatusColor(statusLaserElement);
    updateStatusColor(statusCaylarElement);
    updateStatusColor(statusMercuryElement);
    updateStatusColor(statusRFSoCElement);
    updateStatus(); // Update the status immediately when the page loads
  });
</script>

<script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
<script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>

{% endblock javascripts %}
