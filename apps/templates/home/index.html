{% extends 'layouts/base.html' %} {% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}

<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-7">
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item">
                <a href="#"><i class="fas fa-home"></i></a>
              </li>
              <li class="breadcrumb-item"><a href="#">Dashboards</a></li>
            </ol>
          </nav>
        </div>
      </div>
      <!-- Card stats -->
      <div class="row">
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->

            <div class="card-body" id="card_body_laser">
              <a href="{% url 'laser_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Laser Toptica</h5>
                    <span class="h2 font-weight-bold mb-0" id="laser_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                      <i class="ni ni-active-40"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_rfsoc">
              <a href="{% url 'rfsoc_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">RFSoC</h5>
                    <span class="h2 font-weight-bold mb-0" id="rfsoc_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                      <i class="ni ni-chart-pie-35"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_caylar">
              <a href="{% url 'caylar_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Caylar Magnetic</h5>
                    <span class="h2 font-weight-bold mb-0" id="caylar_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                      <i class="ni ni-money-coins"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body" id="card_body_mercury">
              <a href="{% url 'mercury_page' %}">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">MercuryITC (Cryostat)</h5>
                    <span class="h2 font-weight-bold mb-0" id="mercury_status">Connecting</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                      <i class="ni ni-chart-bar-32"></i>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-secondary my-4" id="update_button">Update Status</button>
    </div>
  </div>
</div>

<!-- Page content -->
<!-- <form id="experimentForms" method="POST" action="{% url 'home' %}"> -->
<form id="experimentForms" method="POST">
  {% csrf_token %} {{ experiment_formset.management_form }}
  <div class="container-fluid mt--6">
    <div class="row">
      <div class="col">
        <div class="card shadow">
          <div class="card-header bg-transparent">
            <h3 class="mb-0">Experiments</h3>
          </div>
          <input type="hidden" id="experimentCountInput" name="experimentCount" value="{{ experiment_forms|length }}" />
          <div class="form-group px-4">
            <label for="id_experiment_name">Experiment Name:</label>
            <input type="text" class="form-control" id="id_experiment_name" name="experiment_name" />
          </div>
          <div class="form-group px-4">
            <label for="id_experiment_description">Experiment Description:</label>
            <textarea class="form-control" id="id_experiment_description" name="description" rows="4"></textarea>
          </div>
          <div class="row px-4">
            <div class="card-body">
              <button type="submit" class="btn btn-primary">Start Experiment</button>
            </div>
            <div class="card-body">
              <button type="button" class="btn btn-primary" onclick="addExperimentForm()">Set Configuration</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{% include "includes/footer.html" %} {% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var experimentCount = {{ experiment_forms|length }};

  function addExperimentForm() {
    var formHtml = `
      <div class="row mt-4 px-4" id="experimentForm${experimentCount}">
        <div class="col">
          <div class="card shadow">
            <div class="card-body">
              <div class="form-group">
                <label for="id_experiment_${experimentCount}-parameter">Select Parameter:</label>
                <select class="form-control" name="device" id="id_experiment_${experimentCount}-parameter" onchange="showOptions(${experimentCount})">
                  <option value="">Select...</option>
                  <option value="laser">Laser</option>
                  <option value="rfsoc">RFSoC</option>
                  <option value="setting_eom_frequency">Setting EOM Frequency</option>
                </select>
              </div>
              <div id="options${experimentCount}" style="display: none;">
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-success" onclick="copyExperimentForm(${experimentCount})">Copy</button>
                <button type="button" class="btn btn-danger" onclick="deleteExperimentForm(${experimentCount})">Delete</button>
                <button type="button" class="btn btn-primary" onclick="addExperimentForm()" experimentCount="${experimentCount}">Add</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    $('#experimentForms').append(formHtml);
    experimentCount++;
    $('#experimentCountInput').val(experimentCount);
  }

  function showOptions(formId) {
    var parameterSelect = document.getElementById(`id_experiment_${formId}-parameter`);
    var selectedValue = parameterSelect.options[parameterSelect.selectedIndex].value;
    var optionsContainer = document.getElementById(`options${formId}`);
    optionsContainer.innerHTML = "";

    if (selectedValue === "laser") {
      var optionsHtml = `
        <div class="form-group">
          <label for="id_experiment_${formId}-laser_parameter">Select Laser Parameter:</label>
          <select class="form-control" name = "laser_parameter" id="id_experiment_${formId}-laser_parameter">
            <option value="">Select...</option>
            <option value="wavelength">Wavelength</option>
            <option value="frequency">Frequency</option>
          </select>
        </div>
        <div class="form-group">
          <label for="id_experiment_${formId}-laser_value">Enter Value:</label>
          <input type="number" step="any" name="laser_value" class="form-control" id="id_experiment_${formId}-laser_value">
        </div>
      `;
      optionsContainer.innerHTML = optionsHtml;
      optionsContainer.style.display = "block";
    } else if (selectedValue === "rfsoc") {
      var optionsHtml = `
        <div class="form-group">
          <label for="id_experiment_${formId}-rfsoc_parameter">Select RFSoC Parameter:</label>
          <select class="form-control" id="id_experiment_${formId}-rfsoc_parameter" onchange="showRFSoCOptions(${formId})">
            <option value="">Select...</option>
            <option value="eom">EOM</option>
            <option value="aom">AOM</option>
          </select>
        </div>
      `;
      optionsContainer.innerHTML = optionsHtml;
      optionsContainer.style.display = "block";
    } else if (selectedValue === "setting_eom_frequency") {
      var optionsHtml = `
        <div class="form-group">
          <label for="id_experiment_${formId}-eom_ab">Select EOM Frequency (A or B):</label>
          <select class="form-control" id="id_experiment_${formId}-eom_ab">
            <option value="">Select...</option>
            <option value="A">A</option>
            <option value="B">B</option>
          </select>
        </div>
        <div class="form-group">
          <label for="id_experiment_${formId}-phase">Phase:</label>
          <input type="number" step="any" class="form-control" id="id_experiment_${formId}-phase">
        </div>
        <div class="form-group">
          <label for="id_experiment_${formId}-gain">Gain:</label>
          <input type="number" step="any" class="form-control" id="id_experiment_${formId}-gain">
        </div>
        <div class="form-group">
          <label for="id_experiment_${formId}-frequency">Frequency:</label>
          <input type="number" step="any" class="form-control" id="id_experiment_${formId}-frequency">
        </div>
      `;
      optionsContainer.innerHTML = optionsHtml;
      optionsContainer.style.display = "block";
    }
  }

  function showRFSoCOptions(formId) {
    var rfsocSelect = document.getElementById(`id_experiment_${formId}-rfsoc_parameter`);
    var selectedValue = rfsocSelect.options[rfsocSelect.selectedIndex].value;
    var optionsContainer = document.getElementById(`options${formId}`);
    optionsContainer.innerHTML = "";

    if (selectedValue === "eom") {
      var optionsHtml = `
      <div class="form-group">
        <label for="id_experiment_${formId}-freq">Select Frequency:</label>
        <select class="form-control" name="eom_frequency" id="id_experiment_${formId}-freq">
          <option value="">Select...</option>
          <option value="A">A</option>
          <option value="B">B</option>
        </select>
      </div>
      <div class="form-group">
        <label for="id_experiment_${formId}-start_time">Start Time:</label>
        <input type="number" name="eom_time_start"step="any" class="form-control" id="id_experiment_${formId}-start_time">
      </div>
      <div class="form-group">
        <label for="id_experiment_${formId}-length">Length:</label>
        <input type="number" name="eom_length" step="any" class="form-control" id="id_experiment_${formId}-length">
      </div>
    `;
      optionsContainer.innerHTML = optionsHtml;
      optionsContainer.style.display = "block";
    } else if (selectedValue === "aom") {
      var optionsHtml = `
      <div class="form-group">
        <label for="id_experiment_${formId}-aom_pins">Select AOM Pins:</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="0" id="id_experiment_${formId}-aom_pins_0">
          <label class="form-check-label" for="id_experiment_${formId}-aom_pins_0">
            Pin 0
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" id="id_experiment_${formId}-aom_pins_1">
          <label class="form-check-label" for="id_experiment_${formId}-aom_pins_1">
            Pin 1
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="2" id="id_experiment_${formId}-aom_pins_2">
          <label class="form-check-label" for="id_experiment_${formId}-aom_pins_2">
            Pin 2
          </label>
        </div>
      </div>
    `;
      optionsContainer.innerHTML = optionsHtml;
      optionsContainer.style.display = "block";
    }
  }

  function copyExperimentForm(formId) {
    var copiedForm = document.getElementById(`experimentForm${formId}`).cloneNode(true);
    var newFormId = experimentCount;

    copiedForm.setAttribute("id", `experimentForm${newFormId}`);
    copiedForm.innerHTML = copiedForm.innerHTML.replace(new RegExp(`id_experiment_${formId}`, "g"), `id_experiment_${newFormId}`);
    copiedForm.innerHTML = copiedForm.innerHTML.replace(new RegExp(`options${formId}`, "g"), `options${newFormId}`);

    $('#experimentForms').append(copiedForm);
    experimentCount++;
    $('#experimentCountInput').val(experimentCount);
  }

  function deleteExperimentForm(formId) {
    var formToRemove = document.getElementById(`experimentForm${formId}`);
    formToRemove.remove();
  }

  $(document).ready(function() {
    $('#addExperimentFormButton').click(function() {
      addExperimentForm();
    });
  });
</script>

<script>
  var statusCaylarElement = $("#caylar_status");
  var statusLaserElement = $("#laser_status");
  var statusRFSoCElement = $("#rfsoc_status");
  var statusMercuryElement = $("#mercury_status");

  function updateStatusColor(statusElement) {
    var statusText = statusElement.text().trim();
    statusElement.removeClass("text-success text-danger").css("color", "");

    if (statusText === "ON") {
      statusElement.addClass("text-success"); // Add green text color class
    } else if (statusText === "OFF") {
      statusElement.addClass("text-danger"); // Add red text color class
    } else {
      statusElement.css("color", "#adb5bd"); // Set text color to #adb5bd (gray)
    }
  }
  function updateStatus() {
    $.ajax({
      url: "{% url 'status' %}", // URL mapped to the status view
      type: "GET",
      dataType: "json",
      success: function (data) {
        document.getElementById("rfsoc_status").innerHTML = data.rfsoc_status;
        document.getElementById("laser_status").innerHTML = data.laser_status;
        document.getElementById("mercury_status").innerHTML = data.mercury_status;
        document.getElementById("caylar_status").innerHTML = data.caylar_status;
        updateStatusColor(statusLaserElement);
        updateStatusColor(statusCaylarElement);
        updateStatusColor(statusMercuryElement);
        updateStatusColor(statusRFSoCElement);
      },
      error: function (xhr, errmsg, err) {
        console.log(xhr.status + ": " + xhr.responseText);
      },
    });
  }

  // Add event listener for the update button
  const updateButton = document.getElementById("update_button");
  updateButton.addEventListener("click", function () {
    updateStatusColor(statusLaserElement);
    updateStatusColor(statusCaylarElement);
    updateStatusColor(statusMercuryElement);
    updateStatusColor(statusRFSoCElement);
    updateStatus(); // Update the status immediately when the page loads
  });

  // Start the script once the HTML has finished loading
  document.addEventListener("DOMContentLoaded", function () {
    updateStatusColor(statusLaserElement);
    updateStatusColor(statusCaylarElement);
    updateStatusColor(statusMercuryElement);
    updateStatusColor(statusRFSoCElement);
    updateStatus(); // Update the status immediately when the page loads
  });
</script>

<script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
<script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>

{% endblock javascripts %}
